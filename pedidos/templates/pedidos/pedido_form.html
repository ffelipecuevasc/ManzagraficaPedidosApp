{% extends 'pedidos/base.html' %}

{% block title %}
    {% if form.instance.pk %}Editar Pedido #{{ form.instance.id }}{% else %}Nuevo Pedido{% endif %} - Manza Gráfica
{% endblock %}

{% block content %}
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
        <div>
            <h1 class="text-2xl font-bold text-slate-900 dark:text-white">
                {% if form.instance.pk %}
                    Editar Pedido <span class="text-primary">#{{ form.instance.id }}</span>
                {% else %}
                    Registrar Nuevo Pedido
                {% endif %}
            </h1>
            <p class="text-slate-500 dark:text-slate-400 text-sm">Sigue los pasos para crear la orden de trabajo.</p>
        </div>
        <a href="{% url 'dashboard' %}" class="text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-white transition-colors flex items-center text-sm font-medium">
            <span class="material-icons-round mr-1 text-lg">arrow_back</span>
            Cancelar
        </a>
    </div>

    <div class="flex justify-center">
        <div class="w-full max-w-4xl">

            <style>
                /* --- INPUTS GENERALES --- */
                .custom-input {
                    width: 100%;
                    background-color: #ffffff;
                    border: 1px solid #d1d5db;
                    border-radius: 0.5rem;
                    padding: 0.625rem 1rem;
                    font-size: 0.95rem;
                    color: #111827;
                    transition: all 0.2s;
                }

                /* Corrección Modo Oscuro para Inputs */
                .dark .custom-input,
                .dark input[type="text"],
                .dark input[type="number"],
                .dark input[type="date"] {
                    background-color: #262626 !important;
                    border-color: #404040 !important;
                    color: #ffffff !important;
                }

                .custom-input:focus {
                    outline: none;
                    border-color: #FBBF24 !important;
                    box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.2);
                }

                /* --- INPUT FILE (SUBIDA DE ARCHIVOS) --- */
                input[type="file"] {
                    display: block;
                    width: 100%;
                    font-size: 0.875rem;
                    color: #4b5563;
                    background-color: #ffffff;
                    border: 1px solid #d1d5db;
                    border-radius: 0.5rem;
                    padding: 0.5rem;
                    cursor: pointer;
                }
                .dark input[type="file"] {
                    background-color: #262626;
                    border-color: #404040;
                    color: #cbd5e1;
                }
                /* El botón 'Examinar' del navegador */
                ::file-selector-button {
                    background-color: #f3f4f6;
                    color: #1f2937;
                    border: 0;
                    border-right: 1px solid #e5e7eb;
                    padding: 0.5rem 1rem;
                    margin-right: 1rem;
                    border-radius: 0.3rem;
                    cursor: pointer;
                    font-weight: 600;
                    font-size: 0.8rem;
                }
                .dark ::file-selector-button {
                    background-color: #404040;
                    color: #ffffff;
                    border-color: #525252;
                }

                /* --- CORRECCIÓN CAMPOS DE MONEDA ($) --- */
                #id_valor_venta, #id_valor_abonado {
                    padding-left: 2rem !important;
                }

                /* --- LABELS --- */
                .custom-label {
                    display: block;
                    font-size: 0.875rem;
                    font-weight: 600;
                    color: #374151;
                    margin-bottom: 0.5rem;
                }
                .dark .custom-label { color: #cbd5e1; }

                /* --- CORRECCIONES SELECT2 --- */
                .select2-container--default .select2-selection--single {
                    height: 46px !important;
                    padding-top: 8px;
                    border-radius: 0.5rem !important;
                }
                .dark .select2-container--default .select2-selection--single {
                    background-color: #262626 !important;
                    border-color: #404040 !important;
                }
                .select2-container--default .select2-selection--single .select2-selection__rendered {
                    line-height: 28px !important;
                    color: #111827 !important;
                }
                .dark .select2-container--default .select2-selection--single .select2-selection__rendered {
                    color: #ffffff !important;
                }
                .dark .select2-dropdown {
                    background-color: #262626 !important;
                    border-color: #404040 !important;
                    color: #ffffff !important;
                }
                .dark .select2-results__option { color: #ffffff !important; }
                .dark .select2-results__option--highlighted {
                    background-color: #FBBF24 !important;
                    color: #000000 !important;
                }
                .dark .select2-search__field {
                    background-color: #171717 !important;
                    color: #ffffff !important;
                    border-color: #404040 !important;
                }

                /* --- SUMMERNOTE --- */
                .note-editor.note-frame { border-radius: 0.5rem !important; overflow: hidden; }
                .dark .note-editor.note-frame { border-color: #404040 !important; }
                .dark .note-toolbar { background-color: #171717 !important; border-bottom-color: #404040 !important; }
                .dark .note-editing-area { background-color: #262626 !important; }
                .dark .note-editable { background-color: #262626 !important; color: #ffffff !important; }
                .dark .note-btn { background-color: #262626 !important; color: #ffffff !important; border-color: #404040 !important; }
            </style>

            <form method="post" id="pedidoForm" enctype="multipart/form-data">
                {% csrf_token %}

                <div class="bg-white dark:bg-card-dark rounded-xl border border-slate-200 dark:border-neutral-800 shadow-sm overflow-hidden mb-6 relative">
                    <div class="absolute left-0 top-0 bottom-0 w-1 bg-primary"></div>
                    <div class="p-6 md:p-8">
                        <h2 class="text-lg font-bold text-slate-900 dark:text-white mb-4 flex items-center">
                            <span class="bg-primary text-black w-6 h-6 rounded-full flex items-center justify-center text-xs mr-3 font-bold">1</span>
                            ¿Quién es el cliente?
                        </h2>
                        <div id="section-buscar-cliente">
                            <div class="mb-4">
                                <label class="custom-label">Buscar en la base de datos:</label>
                                {{ form.cliente }}
                            </div>
                            <div class="flex items-center gap-3 mt-4 pt-4 border-t border-slate-100 dark:border-neutral-800">
                                <span class="text-sm text-slate-500 dark:text-slate-400">¿No lo encuentras?</span>
                                <button type="button" id="btn-toggle-crear" class="text-primary hover:text-yellow-400 font-bold text-sm uppercase tracking-wide flex items-center transition-colors">
                                    <span class="material-icons-round mr-1 text-lg">person_add</span>
                                    Crear Nuevo Cliente
                                </button>
                            </div>
                        </div>

                        <div id="section-crear-cliente" class="hidden bg-slate-50 dark:bg-neutral-900/50 p-6 rounded-lg border border-slate-200 dark:border-neutral-800">
                            <h3 class="font-bold text-slate-800 dark:text-white mb-4 text-sm uppercase tracking-wide">Nuevo Cliente Rápido</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div><label class="custom-label">Nombre *</label><input type="text" id="new_client_nombre" class="custom-input" placeholder="Ej: Juan Pérez"></div>
                                <div><label class="custom-label">Teléfono *</label><input type="text" id="new_client_telefono" class="custom-input" placeholder="+56 9..."></div>
                                <div class="md:col-span-2"><label class="custom-label">Email (Opcional)</label><input type="text" id="new_client_email" class="custom-input" placeholder="ejemplo@correo.com"></div>
                            </div>
                            <div class="flex items-center justify-end gap-3">
                                <button type="button" id="btn-cancelar-crear" class="px-4 py-2 text-sm font-medium text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white transition-colors">Cancelar</button>
                                <button type="button" id="btn-guardar-cliente-api" class="px-4 py-2 bg-slate-900 dark:bg-white text-white dark:text-black rounded-lg font-bold text-sm shadow hover:shadow-lg transition-all flex items-center">
                                    <span class="material-icons-round text-sm mr-2">save</span>
                                    Guardar y Seleccionar
                                </button>
                            </div>
                            <div id="cliente-api-error" class="hidden mt-3 text-xs text-red-500 font-bold text-right"></div>
                        </div>
                    </div>
                </div>

                <div id="section-detalles-pedido" class="hidden opacity-50 transition-all duration-500 bg-white dark:bg-card-dark rounded-xl border border-slate-200 dark:border-neutral-800 shadow-sm overflow-hidden">
                    <div class="absolute left-0 top-0 bottom-0 w-1 bg-slate-300 dark:bg-neutral-700"></div>
                    <div class="p-6 md:p-8">
                        <h2 class="text-lg font-bold text-slate-900 dark:text-white mb-6 flex items-center">
                            <span class="bg-slate-200 dark:bg-neutral-700 text-slate-600 dark:text-slate-300 w-6 h-6 rounded-full flex items-center justify-center text-xs mr-3 font-bold">2</span>
                            Detalles del Trabajo
                        </h2>
                        <div class="space-y-6">
                            <div>
                                <label class="custom-label" for="{{ form.resumen_pedido.id_for_label }}">{{ form.resumen_pedido.label }}</label>
                                {{ form.resumen_pedido }}
                            </div>

                            <div>
                                <label class="custom-label" for="{{ form.imagen_referencia.id_for_label }}">Imagen de Referencia</label>
                                <p class="text-xs text-slate-500 dark:text-slate-400 mb-2">Sube una foto, dibujo o captura del diseño.</p>
                                {{ form.imagen_referencia }}
                            </div>

                            <div>
                                <label class="custom-label" for="{{ form.detalles_pedido.id_for_label }}">{{ form.detalles_pedido.label }}</label>
                                {{ form.detalles_pedido }}
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div>
                                    <label class="custom-label" for="{{ form.valor_venta.id_for_label }}">{{ form.valor_venta.label }}</label>
                                    <div class="relative"><span class="absolute left-3 top-2.5 text-slate-400 select-none">$</span>{{ form.valor_venta }}</div>
                                </div>
                                <div>
                                    <label class="custom-label" for="{{ form.valor_abonado.id_for_label }}">{{ form.valor_abonado.label }}</label>
                                    <div class="relative"><span class="absolute left-3 top-2.5 text-slate-400 select-none">$</span>{{ form.valor_abonado }}</div>
                                </div>
                                <div>
                                    <label class="custom-label" for="{{ form.fecha_entrega.id_for_label }}">{{ form.fecha_entrega.label }}</label>
                                    {{ form.fecha_entrega }}
                                </div>
                            </div>
                        </div>
                        <div class="mt-8 pt-6 border-t border-slate-100 dark:border-neutral-800 flex items-center justify-end gap-3">
                            <button type="submit" class="px-8 py-3 rounded-lg bg-primary hover:bg-yellow-400 text-black font-bold shadow-md hover:shadow-lg transition-all text-sm uppercase tracking-wide flex items-center">
                                <span class="material-icons-round mr-2 text-xl">check_circle</span>
                                Confirmar Pedido
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        $('#id_detalles_pedido').summernote({
            placeholder: 'Escribe aquí las especificaciones...',
            tabsize: 2, height: 200,
            toolbar: [['style', ['bold', 'italic', 'clear']], ['para', ['ul', 'ol']]],
            callbacks: {
                onInit: function() {
                    if($('html').hasClass('dark')) { $('.note-editable').css({'background-color': '#262626', 'color': 'white'}); }
                }
            }
        });
        var $selectCliente = $('#id_cliente');
        $selectCliente.select2({ width: '100%', placeholder: "Escribe para buscar cliente...", allowClear: true });

        var $sectionDetalles = $('#section-detalles-pedido');
        var $sectionBuscar = $('#section-buscar-cliente');
        var $sectionCrear = $('#section-crear-cliente');

        function checkClienteSeleccionado() {
            if ($selectCliente.val()) { $sectionDetalles.removeClass('hidden opacity-50').addClass('opacity-100'); }
            else { $sectionDetalles.addClass('hidden opacity-50').removeClass('opacity-100'); }
        }
        $selectCliente.on('change', checkClienteSeleccionado);
        checkClienteSeleccionado();

        $('#btn-toggle-crear').click(function() { $sectionBuscar.addClass('hidden'); $sectionCrear.removeClass('hidden'); });
        $('#btn-cancelar-crear').click(function() {
            $sectionCrear.addClass('hidden'); $sectionBuscar.removeClass('hidden'); $('#cliente-api-error').addClass('hidden');
        });

        $('#btn-guardar-cliente-api').click(function() {
            var nombre = $('#new_client_nombre').val();
            var telefono = $('#new_client_telefono').val();
            var email = $('#new_client_email').val();

            if(!nombre || !telefono) { $('#cliente-api-error').text('Nombre y Teléfono son obligatorios').removeClass('hidden'); return; }

            var $btn = $(this);
            var originalText = $btn.html();
            $btn.prop('disabled', true).html('<span class="material-icons-round animate-spin text-sm mr-2">refresh</span> Guardando...');

            fetch("{% url 'api_crear_cliente_rapido' %}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'X-CSRFToken': '{{ csrf_token }}' },
                body: new URLSearchParams({ 'nombre': nombre, 'telefono': telefono, 'email': email })
            })
            .then(response => response.json())
            .then(data => {
                if(data.success) {
                    var newOption = new Option(data.nombre, data.id, true, true);
                    $selectCliente.append(newOption).trigger('change');
                    $sectionCrear.addClass('hidden');
                    $sectionBuscar.removeClass('hidden');
                    $('#new_client_nombre').val(''); $('#new_client_telefono').val(''); $('#new_client_email').val('');
                    checkClienteSeleccionado();
                } else {
                    $('#cliente-api-error').text('Error: ' + JSON.stringify(data.errors)).removeClass('hidden');
                }
            })
            .catch(error => { console.error('Error:', error); $('#cliente-api-error').text('Error de conexión').removeClass('hidden'); })
            .finally(() => { $btn.prop('disabled', false).html(originalText); });
        });
    });
</script>
{% endblock %}